# ... [cabe√ßalho e fun√ß√µes anteriores mantidos]

# üîù Informa√ß√µes gerais da vers√£o
if linha_selecionada is not None and isinstance(linha_selecionada, pd.Series):
    st.markdown("### üßæ Vers√£o do Projeto")

    linha_selecionada["NomeProjeto"] = st.text_input("Nome do Projeto", value=linha_selecionada["NomeProjeto"])
    
    nome_usuario = st.text_input("Seu nome", value="Vitor")
    linha_selecionada["UltimoUsuario"] = f"{nome_usuario} + Copilot"
    linha_selecionada["UltimaModificacao"] = datetime.now().strftime('%d/%m/%Y %H:%M')

    st.markdown("### üìé Anexos do Projeto")
    adicionar_anexos = st.radio("Adicionar anexos?", ["N√£o", "Sim"])
    if adicionar_anexos == "Sim":
        qtd_anexos = st.number_input("Selecione a quantidade de anexos", min_value=1, max_value=5, step=1)
        for i in range(1, 6):
            if i <= qtd_anexos:
                linha_selecionada[f"Anexo{i}"] = st.text_input(f"Insira o nome do anexo {i}")
            else:
                linha_selecionada[f"Anexo{i}"] = ""

# üîª Separa√ß√£o visual entre vers√£o e dados t√©cnicos
st.markdown("---")
st.markdown("### üß± √Årea da edifica√ß√£o A-2")
linha_selecionada["Area"] = st.number_input("√Årea da edifica√ß√£o A-2 (m¬≤)", value=float(linha_selecionada["Area"]))

st.markdown("### üèóÔ∏è Altura da edifica√ß√£o")

# Perguntas condicionais
linha_selecionada["SubsoloTecnico"] = st.radio("Existe subsolo de estacionamento, √°rea t√©cnica ou sem ocupa√ß√£o de pessoas?", ["N√£o", "Sim"])
if linha_selecionada["SubsoloTecnico"] == "Sim":
    st.markdown("<span style='color:red'>‚ö†Ô∏è Se tiver mais de 0,006m¬≤ por m¬≥ do pavimento ou sua laje de teto estiver acima, em pelo menos, 1,2m do perfil natural em pelo menos um lado, n√£o √© subsolo e deve ser considerado na altura</span>", unsafe_allow_html=True)
    linha_selecionada["SubsoloComOcupacao"] = st.radio("Um dos dois primeiros subsolos abaixo do t√©rreo possui ocupa√ß√£o secund√°ria?", ["N√£o", "Sim"])
    if linha_selecionada["SubsoloComOcupacao"] == "Sim":
        linha_selecionada["SubsoloMenor50m2"] = st.radio("Essa ocupa√ß√£o secund√°ria tem no m√°ximo 50m¬≤ em cada subsolo?", ["N√£o", "Sim"])

linha_selecionada["DuplexUltimoPavimento"] = st.radio("Existe duplex no √∫ltimo pavimento?", ["N√£o", "Sim"])
linha_selecionada["AticoOuCasaMaquinas"] = st.radio("H√° pavimento de √°tico/casa de m√°quinas/casa de bombas acima do √∫ltimo pavimento?", ["N√£o", "Sim"])

# Campo de altura
linha_selecionada["Altura"] = st.number_input("Altura da edifica√ß√£o (m)", value=float(linha_selecionada["Altura"]))

# üß† Frase explicativa da altura
explicacao = ""
s1 = linha_selecionada["SubsoloTecnico"]
s2 = linha_selecionada.get("SubsoloComOcupacao", "N√£o")
s3 = linha_selecionada.get("SubsoloMenor50m2", "N√£o")
duplex = linha_selecionada["DuplexUltimoPavimento"]

if s1 == "N√£o" and s2 == "N√£o":
    explicacao = "Altura da edifica√ß√£o √©: Cota de piso do √∫ltimo pavimento habitado - cota de piso do pavimento mais baixo, exceto subsolos"
elif s1 == "N√£o" and duplex == "Sim":
    explicacao = "Altura da edifica√ß√£o √©: Cota de piso do primeiro pavimento duplex - cota de piso do pavimento mais baixo, exceto subsolos"
elif s1 == "Sim" and s2 == "N√£o":
    explicacao = "Altura da edifica√ß√£o √©: Cota de piso do √∫ltimo pavimento habitado - cota de piso do pavimento mais baixo, exceto subsolos"
elif s1 == "Sim" and s2 == "Sim" and s3 == "Sim":
    explicacao = "Altura da edifica√ß√£o √©: Cota de piso do √∫ltimo pavimento habitado - cota de piso do pavimento mais baixo, exceto subsolos"
elif s1 == "Sim" and s2 == "Sim" and s3 == "N√£o":
    explicacao = "Altura da edifica√ß√£o √©: Cota de piso do √∫ltimo pavimento habitado - cota de piso do subsolo em que a ocupa√ß√£o secund√°ria ultrapassa 50m¬≤"

if explicacao:
    st.markdown(f"üí° **{explicacao}**")

# Finaliza√ß√£o
df_novo = pd.DataFrame([linha_selecionada])
if modo == "üìÑ Revisar projeto existente" and arquivo is not None:
    df = pd.concat([df, df_novo], ignore_index=True)
else:
    df = df_novo.copy()

nome_projeto = linha_selecionada["NomeProjeto"]
nome_arquivo_saida = gerar_nome_arquivo(nome_projeto, nome_arquivo_entrada)

output = io.BytesIO()
df.to_excel(output, index=False)

st.download_button(
    "üì• Baixar planilha atualizada",
    data=output.getvalue(),
    file_name=nome_arquivo_saida
)
